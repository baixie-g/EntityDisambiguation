# å®ä½“æ¶ˆæ­§æœåŠ¡ - æ•°æ®åº“æ¶æ„è¯´æ˜

## ğŸ—ï¸ æ•°æ®åº“æ¶æ„æ¦‚è¿°

å®ä½“æ¶ˆæ­§æœåŠ¡é‡‡ç”¨**åŒæ•°æ®åº“æ¶æ„**ï¼Œæ˜ç¡®åˆ†ç¦»ä¸åŒç±»å‹çš„æ•°æ®å­˜å‚¨ï¼š

### 1. Neo4j å›¾æ•°æ®åº“ - å®ä½“å­˜å‚¨
- **ç”¨é€”**: å­˜å‚¨å®ä½“çš„ä¸»è¦ä¸šåŠ¡æ•°æ®
- **æ•°æ®ç±»å‹**: å®ä½“ä¿¡æ¯ã€å®ä½“å…³ç³»ã€å®ä½“å±æ€§
- **ä¼˜åŠ¿**: 
  - å¤©ç„¶æ”¯æŒå›¾ç»“æ„å’Œå…³ç³»æŸ¥è¯¢
  - é«˜æ•ˆçš„å®ä½“å…³ç³»éå†
  - çµæ´»çš„å›¾æ¨¡å¼è®¾è®¡
  - æ”¯æŒå¤æ‚çš„å®ä½“å…³è”æŸ¥è¯¢

### 2. SQLite å…³ç³»æ•°æ®åº“ - å†å²è®°å½•å­˜å‚¨
- **ç”¨é€”**: å­˜å‚¨æ¶ˆæ­§å†³ç­–çš„å†å²è®°å½•
- **æ•°æ®ç±»å‹**: æ¶ˆæ­§å†å²ã€å†³ç­–ç»Ÿè®¡ã€å®¡è®¡æ—¥å¿—
- **ä¼˜åŠ¿**:
  - è½»é‡çº§ï¼Œæ— éœ€é¢å¤–æœåŠ¡
  - äº‹åŠ¡æ€§å¼ºï¼Œæ•°æ®ä¸€è‡´æ€§å¥½
  - é€‚åˆç»“æ„åŒ–çš„å†å²æ•°æ®å­˜å‚¨
  - æ–¹ä¾¿è¿›è¡Œç»Ÿè®¡åˆ†æ

## ğŸ“Š æ•°æ®åº“è¯¦ç»†è®¾è®¡

### Neo4j å®ä½“æ•°æ®æ¨¡å‹

```cypher
// å®ä½“èŠ‚ç‚¹
(:Entity {
  id: string,           // å®ä½“å”¯ä¸€æ ‡è¯†
  name: string,         // å®ä½“åç§°
  type: string,         // å®ä½“ç±»å‹ (ç–¾ç—…ã€ç—‡çŠ¶ã€è¯ç‰©ç­‰)
  aliases: [string],    // å®ä½“åˆ«ååˆ—è¡¨
  definition: string,   // å®ä½“å®šä¹‰
  attributes: string,   // JSONæ ¼å¼çš„å±æ€§æ•°æ®
  source: string,       // æ•°æ®æ¥æº
  create_time: string,  // åˆ›å»ºæ—¶é—´ (ISOæ ¼å¼)
  updated_time: string  // æ›´æ–°æ—¶é—´ (ISOæ ¼å¼)
})

// å®ä½“å…³ç³»
(:Entity)-[:RELATIONSHIP {
  type: string,         // å…³ç³»ç±»å‹
  confidence: float,    // å…³ç³»ç½®ä¿¡åº¦
  source: string,       // å…³ç³»æ¥æº
  created_at: string    // åˆ›å»ºæ—¶é—´
}]->(:Entity)
```

### SQLite å†å²è®°å½•æ•°æ®æ¨¡å‹

```sql
-- æ¶ˆæ­§å†å²è¡¨
CREATE TABLE disambiguation_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    input_entity TEXT NOT NULL,          -- è¾“å…¥å®ä½“JSON
    decision TEXT NOT NULL,              -- å†³ç­–ç±»å‹ (merge/create/ambiguous)
    match_id TEXT,                       -- åŒ¹é…å®ä½“ID
    match_entity TEXT,                   -- åŒ¹é…å®ä½“JSON
    scores TEXT NOT NULL,                -- ç›¸ä¼¼åº¦åˆ†æ•°JSON
    reasoning TEXT,                      -- æ¨ç†è¿‡ç¨‹
    timestamp TEXT DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_history_timestamp ON disambiguation_history(timestamp);
CREATE INDEX idx_history_decision ON disambiguation_history(decision);
CREATE INDEX idx_history_match_id ON disambiguation_history(match_id);
```

## ğŸ”§ æ•°æ®åº“æœåŠ¡æ¶æ„

### DatabaseManager ç»Ÿä¸€ç®¡ç†å™¨

```python
class DatabaseManager:
    """æ•°æ®åº“ç®¡ç†å™¨ - ç»Ÿä¸€ç®¡ç†å®ä½“å­˜å‚¨å’Œå†å²è®°å½•"""
    
    def __init__(self):
        self.neo4j_service = None      # Neo4jå®ä½“å­˜å‚¨æœåŠ¡
        self.history_service = None    # SQLiteå†å²è®°å½•æœåŠ¡
    
    # === å®ä½“å­˜å‚¨ç›¸å…³æ–¹æ³• (Neo4j) ===
    def save_entity(self, entity: Entity) -> bool
    def get_entity(self, entity_id: str) -> Optional[Entity]
    def get_all_entities(self) -> List[Entity]
    def search_entities(self, query: str) -> List[Entity]
    def create_entity_relationship(self, ...) -> bool
    
    # === å†å²è®°å½•ç›¸å…³æ–¹æ³• (SQLite) ===
    def save_disambiguation_history(self, history: DisambiguationHistory) -> bool
    def get_disambiguation_history(self, limit: int) -> List[DisambiguationHistory]
    def get_decision_stats(self) -> dict
```

### æœåŠ¡ç»„ä»¶åˆ†å·¥

1. **Neo4jDatabaseService** - ä¸“é—¨å¤„ç†Neo4jå®ä½“å­˜å‚¨
2. **HistoryDatabaseService** - ä¸“é—¨å¤„ç†SQLiteå†å²è®°å½•
3. **DatabaseManager** - ç»Ÿä¸€ç®¡ç†ä¸¤ä¸ªæ•°æ®åº“æœåŠ¡

## ğŸš€ ä½¿ç”¨æ–¹å¼

### 1. é…ç½®æ•°æ®åº“è¿æ¥

```python
# config/settings.py
class Settings(BaseSettings):
    # Neo4jé…ç½®ï¼ˆå®ä½“å­˜å‚¨ï¼‰
    NEO4J_URI: str = "bolt://localhost:7687"
    NEO4J_USER: str = "neo4j"
    NEO4J_PASSWORD: str = "password"
    NEO4J_DATABASE: str = "neo4j"
    
    # SQLiteé…ç½®ï¼ˆå†å²è®°å½•ï¼‰
    SQLITE_DATABASE_PATH: str = "data/disambiguation_history.db"
```

### 2. åˆå§‹åŒ–æ•°æ®åº“

```python
from services import db_manager

# åˆå§‹åŒ–ä¸¤ä¸ªæ•°æ®åº“
db_manager.init_databases()

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
if db_manager.is_ready():
    print("æ•°æ®åº“æœåŠ¡å°±ç»ª")
```

### 3. ä½¿ç”¨æ•°æ®åº“æœåŠ¡

```python
# ä¿å­˜å®ä½“åˆ°Neo4j
entity = Entity(name="ç³–å°¿ç—…", type="ç–¾ç—…", ...)
db_manager.save_entity(entity)

# ä¿å­˜å†å²è®°å½•åˆ°SQLite
history = DisambiguationHistory(...)
db_manager.save_disambiguation_history(history)

# æŸ¥è¯¢å®ä½“
entities = db_manager.get_all_entities()

# æŸ¥è¯¢å†å²
histories = db_manager.get_disambiguation_history(limit=100)
```

## ğŸ“‹ åˆå§‹åŒ–è„šæœ¬

### 1. æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
```bash
python check_database_status.py
```

### 2. åˆå§‹åŒ–Neo4jå®ä½“æ•°æ®
```bash
python init_neo4j_data.py
```

### 3. å¯åŠ¨æœåŠ¡
```bash
python main.py
```

## ğŸ” æ•°æ®æµå‘

1. **å®ä½“æ¶ˆæ­§è¯·æ±‚** â†’ ä»Neo4jæŸ¥è¯¢ç›¸ä¼¼å®ä½“
2. **æ¶ˆæ­§å†³ç­–è¿‡ç¨‹** â†’ è®¡ç®—ç›¸ä¼¼åº¦åˆ†æ•°
3. **å†³ç­–ç»“æœ** â†’ ä¿å­˜å†å²è®°å½•åˆ°SQLite
4. **å¦‚æœæ˜¯åˆå¹¶å†³ç­–** â†’ æ›´æ–°Neo4jä¸­çš„å®ä½“å…³ç³»
5. **å¦‚æœæ˜¯æ–°å»ºå†³ç­–** â†’ åœ¨Neo4jä¸­åˆ›å»ºæ–°å®ä½“

## ğŸ¯ ä¼˜åŠ¿æ€»ç»“

1. **èŒè´£åˆ†ç¦»**: å®ä½“æ•°æ®å’Œå†å²è®°å½•åˆ†ç¦»å­˜å‚¨
2. **æ€§èƒ½ä¼˜åŒ–**: Neo4jé€‚åˆå›¾æŸ¥è¯¢ï¼ŒSQLiteé€‚åˆå†å²åˆ†æ
3. **æ‰©å±•æ€§**: å¯ä»¥ç‹¬ç«‹æ‰©å±•å®ä½“å­˜å‚¨å’Œå†å²è®°å½•å­˜å‚¨
4. **æ•°æ®å®‰å…¨**: ä¸»è¦ä¸šåŠ¡æ•°æ®å’Œå®¡è®¡æ•°æ®åˆ†ç¦»
5. **ç»´æŠ¤æ€§**: ä¸åŒç±»å‹æ•°æ®çš„å¤‡ä»½å’Œç»´æŠ¤ç­–ç•¥å¯ä»¥ç‹¬ç«‹åˆ¶å®š

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### Neo4jè¿æ¥é—®é¢˜
- æ£€æŸ¥Neo4jæœåŠ¡æ˜¯å¦å¯åŠ¨
- éªŒè¯è¿æ¥é…ç½® (URI, ç”¨æˆ·å, å¯†ç )
- ç¡®è®¤Neo4jé©±åŠ¨å·²å®‰è£…: `pip install neo4j`

### SQLiteè¿æ¥é—®é¢˜
- æ£€æŸ¥æ–‡ä»¶è·¯å¾„æƒé™
- ç¡®è®¤dataç›®å½•å­˜åœ¨
- éªŒè¯SQLiteæ–‡ä»¶æ˜¯å¦æŸå

### æœåŠ¡åˆå§‹åŒ–é—®é¢˜
- è¿è¡Œ `python check_database_status.py` æ£€æŸ¥çŠ¶æ€
- æŸ¥çœ‹æ—¥å¿—è¾“å‡ºä¸­çš„é”™è¯¯ä¿¡æ¯
- ç¡®è®¤æ‰€æœ‰ä¾èµ–åŒ…å·²å®‰è£…

---

**è¿™ç§åŒæ•°æ®åº“æ¶æ„ç¡®ä¿äº†å®ä½“æ¶ˆæ­§æœåŠ¡çš„é«˜æ•ˆè¿è¡Œå’Œæ•°æ®å®‰å…¨æ€§ï¼** ğŸ‰ 